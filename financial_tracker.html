<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Financial Tracker</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .hidden { display: none; }

      .landing {
        max-width: 800px;
        margin: 10vh auto 0;
        background: rgba(255,255,255,0.95);
        border-radius: 16px;
        padding: 40px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      }
      .landing h1 {
        margin-bottom: 10px;
      }
      .landing p { color: #444; margin: 10px 0 20px; }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
        font-size: 2.5em;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .card {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
      }

      .card:hover {
        transform: translateY(-5px);
      }

      .card h3 {
        color: #555;
        font-size: 0.9em;
        text-transform: uppercase;
        margin-bottom: 10px;
      }

      .card .amount {
        font-size: 1.8em;
        font-weight: bold;
        color: #333;
      }

      .positive {
        color: #27ae60;
      }
      .negative {
        color: #e74c3c;
      }

      .section {
        margin-bottom: 30px;
      }

      .section-title {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 15px;
        border-radius: 10px 10px 0 0;
        font-size: 1.3em;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
      }

      th {
        background: #f8f9fa;
        font-weight: 600;
        color: #555;
      }

      tr:hover {
        background: #f8f9fa;
      }

      input[type="text"],
      input[type="number"],
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      input[type="number"] {
        text-align: right;
      }

      .btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: opacity 0.3s;
      }

      .btn:hover {
        opacity: 0.9;
      }

      .btn-delete {
        background: #e74c3c;
        padding: 5px 10px;
      }

      .chart-container {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        margin-top: 30px;
      }

      #netWorthChart {
        max-width: 100%;
        height: 300px;
      }

      .date-selector {
        margin-bottom: 20px;
        text-align: center;
      }

      .date-selector input {
        margin: 0 10px;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ddd;
      }

      .export-btn {
        background: #27ae60;
        margin-left: 10px;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .metric-box {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .metric-box h3 {
        color: #667eea;
        margin-bottom: 15px;
      }

      .metric-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 10px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        transition: width 0.5s ease;
      }
    </style>
  </head>
  <body>
    <div id="auth-landing" class="landing">
      <h1>üí∞ Financial Tracker</h1>
      <p>Sign in to start tracking your assets, debts, and net worth.</p>
      <button id="btn-login" class="btn">üîê Sign in with Auth0</button>
    </div>

    <div id="app-container" class="container hidden">
      <h1>üí∞ Financial Tracker</h1>

      <div class="date-selector">
        <label>Record Date:</label>
        <input type="date" id="recordDate" value="" />
        <span style="margin:0 10px; color:#555" id="user-info"></span>
        <button id="btn-logout" class="btn" style="background:#555">üö™ Logout</button>
        <button class="btn" onclick="saveSnapshot()">
          üíæ Save Snapshot
        </button>
        <button class="btn export-btn" onclick="exportToExcel()">
          üìä Export to Excel
        </button>
      </div>

      <div class="summary-cards">
        <div class="card">
          <h3>Total Assets</h3>
          <div class="amount positive" id="totalAssets">CAD $0</div>
        </div>
        <div class="card">
          <h3>Total Liabilities</h3>
          <div class="amount negative" id="totalLiabilities">CAD $0</div>
        </div>
        <div class="card">
          <h3>Net Worth</h3>
          <div class="amount" id="netWorth">CAD $0</div>
        </div>
        <div class="card">
          <h3>Debt-to-Assets Ratio</h3>
          <div class="amount" id="debtRatio">0%</div>
        </div>
        <div class="card">
          <h3>Period Change</h3>
          <div class="amount" id="periodChange">CAD $0</div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">
          <span>üìà Assets</span>
          <button class="btn" onclick="addAssetRow()">+ Add Asset</button>
        </div>
        <table id="assetsTable">
          <thead>
            <tr>
              <th>Category</th>
              <th>Name</th>
              <th>Amount (CAD $)</th>
              <th>% of Assets</th>
              <th>Note</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <select>
                  <option>Cash</option>
                  <option>Bank Account</option>
                  <option>Investments</option>
                  <option>Real Estate</option>
                  <option>Vehicle</option>
                  <option>RRSP</option>
                  <option>TFSA</option>
                  <option>Other</option>
                </select>
              </td>
              <td><input type="text" value="Working Cash" /></td>
              <td>
                <input
                  type="number"
                  value="4000"
                  onchange="calculateTotals()"
                />
              </td>
              <td class="percentage">0%</td>
              <td><input type="text" value="Do not touch" /></td>
              <td>
                <button class="btn btn-delete" onclick="deleteRow(this)">
                  Delete
                </button>
              </td>
            </tr>
            <tr>
              <td>
                <select>
                  <option>Cash</option>
                  <option>Bank Account</option>
                  <option>Investments</option>
                  <option>Real Estate</option>
                  <option>Vehicle</option>
                  <option>RRSP</option>
                  <option>TFSA</option>
                  <option>Other</option>
                </select>
              </td>
              <td><input type="text" value="Reserve Cash" /></td>
              <td>
                <input
                  type="number"
                  value="10000"
                  onchange="calculateTotals()"
                />
              </td>
              <td class="percentage">0%</td>
              <td><input type="text" value="Emergency Fund" /></td>
              <td>
                <button class="btn btn-delete" onclick="deleteRow(this)">
                  Delete
                </button>
              </td>
            </tr>
            <tr>
              <td>
                <select>
                  <option>Cash</option>
                  <option>Bank Account</option>
                  <option>Investments</option>
                  <option>Real Estate</option>
                  <option>Vehicle</option>
                  <option selected>RRSP</option>
                  <option>TFSA</option>
                  <option>Other</option>
                </select>
              </td>
              <td><input type="text" value="RRSP Accounts" /></td>
              <td>
                <input
                  type="number"
                  value="15000"
                  onchange="calculateTotals()"
                />
              </td>
              <td class="percentage">0%</td>
              <td><input type="text" value="Retirement Savings" /></td>
              <td>
                <button class="btn btn-delete" onclick="deleteRow(this)">
                  Delete
                </button>
              </td>
            </tr>
            <tr>
              <td>
                <select>
                  <option>Cash</option>
                  <option>Bank Account</option>
                  <option>Investments</option>
                  <option selected>Real Estate</option>
                  <option>Vehicle</option>
                  <option>RRSP</option>
                  <option>TFSA</option>
                  <option>Other</option>
                </select>
              </td>
              <td><input type="text" value="House" /></td>
              <td>
                <input
                  type="number"
                  value="320000"
                  onchange="calculateTotals()"
                />
              </td>
              <td class="percentage">0%</td>
              <td><input type="text" value="Primary Residence" /></td>
              <td>
                <button class="btn btn-delete" onclick="deleteRow(this)">
                  Delete
                </button>
              </td>
            </tr>
            <tr>
              <td>
                <select>
                  <option>Cash</option>
                  <option>Bank Account</option>
                  <option>Investments</option>
                  <option>Real Estate</option>
                  <option selected>Vehicle</option>
                  <option>RRSP</option>
                  <option>TFSA</option>
                  <option>Other</option>
                </select>
              </td>
              <td><input type="text" value="Car" /></td>
              <td>
                <input
                  type="number"
                  value="35000"
                  onchange="calculateTotals()"
                />
              </td>
              <td class="percentage">0%</td>
              <td><input type="text" value="" /></td>
              <td>
                <button class="btn btn-delete" onclick="deleteRow(this)">
                  Delete
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="section">
        <div class="section-title">
          <span>üìâ Debts and Liabilities</span>
          <button class="btn" onclick="addLiabilityRow()">
            + Add Debt
          </button>
        </div>
        <table id="liabilitiesTable">
          <thead>
            <tr>
              <th>Debt Type</th>
              <th>Creditor</th>
              <th>Outstanding Balance (CAD $)</th>
              <th>Monthly Payment</th>
              <th>Interest Rate</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <select>
                  <option selected>Mortgage</option>
                  <option>Car Loan</option>
                  <option>Personal Loan</option>
                  <option>Credit Card</option>
                  <option>Private Loan</option>
                  <option>Other</option>
                </select>
              </td>
              <td><input type="text" value="Primary Mortgage" /></td>
              <td>
                <input
                  type="number"
                  value="210000"
                  onchange="calculateTotals()"
                />
              </td>
              <td><input type="number" placeholder="0" /></td>
              <td><input type="text" placeholder="%" /></td>
              <td>
                <button class="btn btn-delete" onclick="deleteRow(this)">
                  Delete
                </button>
              </td>
            </tr>
            <tr>
              <td>
                <select>
                  <option>Mortgage</option>
                  <option selected>Car Loan</option>
                  <option>Personal Loan</option>
                  <option>Credit Card</option>
                  <option>Private Loan</option>
                  <option>Other</option>
                </select>
              </td>
              <td><input type="text" value="Car Loan" /></td>
              <td>
                <input
                  type="number"
                  value="39000"
                  onchange="calculateTotals()"
                />
              </td>
              <td><input type="number" placeholder="0" /></td>
              <td><input type="text" placeholder="%" /></td>
              <td>
                <button class="btn btn-delete" onclick="deleteRow(this)">
                  Delete
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="metrics-grid">
        <div class="metric-box">
          <h3>üìä Key Metrics</h3>
          <div class="metric-item">
            <span>Home Equity:</span>
            <span id="homeEquity">CAD $0</span>
          </div>
          <div class="metric-item">
            <span>Liquid Assets:</span>
            <span id="liquidAssets">CAD $0</span>
          </div>
          <div class="metric-item">
            <span>Investments (RRSP/TFSA):</span>
            <span id="investments">CAD $0</span>
          </div>
          <div class="metric-item">
            <span>Total Debt:</span>
            <span id="totalDebt">CAD $0</span>
          </div>
        </div>

        <div class="metric-box">
          <h3>üéØ Debt Repayment Progress</h3>
          <div>
            <div class="metric-item">
              <span>Mortgage Paid:</span>
              <span id="mortgageProgress">0%</span>
            </div>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="mortgageBar"
                style="width: 0%"
              ></div>
            </div>
          </div>
          <div style="margin-top: 15px">
            <div class="metric-item">
              <span>Car Loan Paid:</span>
              <span id="autoProgress">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="autoBar" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <h2>üìä Net Worth Trend</h2>
        <canvas id="netWorthChart"></canvas>
      </div>
    </div>

    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>
    <script>
      // ==== Auth0 SPA Setup ====
      const authConfig = {
        domain: "dev-1qlaqx8pn3fopdzo.us.auth0.com", // your Auth0 domain
        clientId: "T0jOPj5apIGhd4r6j39a1sPOwcXc360P", // Auth0 SPA Client ID
        audience: "https://financial-tracker.api",
      };

      let auth0Client;

      async function updateUI() {
        const isAuth = await auth0Client.isAuthenticated();
        const landing = document.getElementById("auth-landing");
        const app = document.getElementById("app-container");
        const userInfo = document.getElementById("user-info");
        const logoutBtn = document.getElementById("btn-logout");

        if (isAuth) {
          landing.classList.add("hidden");
          app.classList.remove("hidden");
          const user = await auth0Client.getUser();
          userInfo.textContent = user && (user.name || user.email) ? `Hello, ${user.name || user.email}` : "";
          logoutBtn.style.display = "inline-block";
        } else {
          app.classList.add("hidden");
          landing.classList.remove("hidden");
          userInfo.textContent = "";
          logoutBtn.style.display = "none";
        }
      }

      async function initAuth() {
        auth0Client = await createAuth0Client({
          domain: authConfig.domain,
          clientId: authConfig.clientId,
          authorizationParams: {
            audience: authConfig.audience,
            redirect_uri: window.location.origin + "/financial_tracker.html",
          },
          cacheLocation: "localstorage",
        });

        // Handle redirect back from Auth0
        const query = window.location.search;
        if (query.includes("code=") && query.includes("state=")) {
          await auth0Client.handleRedirectCallback();
          window.history.replaceState({}, document.title, window.location.pathname);
        }

        document.getElementById("btn-login").addEventListener("click", () => {
          auth0Client.loginWithRedirect();
        });
        document.getElementById("btn-logout").addEventListener("click", () => {
          auth0Client.logout({ logoutParams: { returnTo: window.location.origin + "/financial_tracker.html" } });
        });

        await updateUI();
      }

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
      document.getElementById("recordDate").value = new Date()
        .toISOString()
        .split("T")[0];

      // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
      let financialData = JSON.parse(
        localStorage.getItem("financialData") || '{"snapshots": []}'
      );

      function formatCAD(amount) {
        return (
          "CAD $" +
          Math.abs(amount).toLocaleString("en-CA", {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          })
        );
      }

      function addAssetRow() {
        const tbody = document.querySelector("#assetsTable tbody");
        const newRow = tbody.insertRow();
        newRow.innerHTML = `
                <td>
                    <select>
                        <option>Cash</option>
                        <option>Bank Account</option>
                        <option>Investments</option>
                        <option>Real Estate</option>
                        <option>Vehicle</option>
                        <option>RRSP</option>
                        <option>TFSA</option>
                        <option>Other</option>
                    </select>
                </td>
                <td><input type="text" placeholder="Name"></td>
                <td><input type="number" placeholder="0" onchange="calculateTotals()"></td>
                <td class="percentage">0%</td>
                <td><input type="text" placeholder="Note"></td>
                <td><button class="btn btn-delete" onclick="deleteRow(this)">Delete</button></td>
            `;
      }

      function addLiabilityRow() {
        const tbody = document.querySelector("#liabilitiesTable tbody");
        const newRow = tbody.insertRow();
        newRow.innerHTML = `
                <td>
                    <select>
                        <option>Mortgage</option>
                        <option>Car Loan</option>
                        <option>Personal Loan</option>
                        <option>Credit Card</option>
                        <option>Private Loan</option>
                        <option>Other</option>
                    </select>
                </td>
                <td><input type="text" placeholder="Bank/Creditor Name"></td>
                <td><input type="number" placeholder="0" onchange="calculateTotals()"></td>
                <td><input type="number" placeholder="0"></td>
                <td><input type="text" placeholder="%"></td>
                <td><button class="btn btn-delete" onclick="deleteRow(this)">Delete</button></td>
            `;
      }

      function deleteRow(btn) {
        btn.closest("tr").remove();
        calculateTotals();
      }

      function calculateTotals() {
        // –ü–æ–¥—Å—á–µ—Ç –∞–∫—Ç–∏–≤–æ–≤
        let totalAssets = 0;
        let liquidAssets = 0;
        let investments = 0;
        let homeValue = 0;

        const assetRows = document.querySelectorAll("#assetsTable tbody tr");
        assetRows.forEach((row) => {
          const category = row.cells[0].querySelector("select").value;
          const amount =
            parseFloat(row.cells[2].querySelector("input").value) || 0;
          totalAssets += amount;

          // –ü–æ–¥—Å—á–µ—Ç –ª–∏–∫–≤–∏–¥–Ω—ã—Ö –∞–∫—Ç–∏–≤–æ–≤
          if (category === "Cash" || category === "Bank Account") {
            liquidAssets += amount;
          }

          // –ü–æ–¥—Å—á–µ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π
          if (
            category === "RRSP" ||
            category === "TFSA" ||
            category === "Investments"
          ) {
            investments += amount;
          }

          // –°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ–º–∞
          if (category === "Real Estate") {
            homeValue += amount;
          }

          // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
          if (totalAssets > 0) {
            row.cells[3].textContent =
              ((amount / totalAssets) * 100).toFixed(1) + "%";
          }
        });

        // –ü–æ–¥—Å—á–µ—Ç –¥–æ–ª–≥–æ–≤
        let totalLiabilities = 0;
        let mortgageDebt = 0;
        let autoDebt = 0;

        const liabilityRows = document.querySelectorAll(
          "#liabilitiesTable tbody tr"
        );
        liabilityRows.forEach((row) => {
          const type = row.cells[0].querySelector("select").value;
          const amount =
            parseFloat(row.cells[2].querySelector("input").value) || 0;
          totalLiabilities += amount;

          if (type === "Mortgage") {
            mortgageDebt += amount;
          }
          if (type === "Car Loan") {
            autoDebt += amount;
          }
        });

        // –†–∞—Å—á–µ—Ç —á–∏—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        const netWorth = totalAssets - totalLiabilities;
        const debtRatio =
          totalAssets > 0 ? (totalLiabilities / totalAssets) * 100 : 0;

        // –†–∞—Å—á–µ—Ç equity –≤ –¥–æ–º–µ
        const homeEquity = homeValue - mortgageDebt;

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
        document.getElementById("totalAssets").textContent =
          formatCAD(totalAssets);
        document.getElementById("totalLiabilities").textContent =
          formatCAD(totalLiabilities);
        document.getElementById("netWorth").textContent = formatCAD(netWorth);
        document.getElementById("netWorth").className =
          netWorth >= 0 ? "amount positive" : "amount negative";
        document.getElementById("debtRatio").textContent =
          debtRatio.toFixed(1) + "%";
        document.getElementById("debtRatio").className =
          debtRatio > 60 ? "amount negative" : "amount positive";

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
        document.getElementById("homeEquity").textContent =
          formatCAD(homeEquity);
        document.getElementById("liquidAssets").textContent =
          formatCAD(liquidAssets);
        document.getElementById("investments").textContent =
          formatCAD(investments);
        document.getElementById("totalDebt").textContent =
          formatCAD(totalLiabilities);

        // –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–≥–∞—à–µ–Ω–∏—è –∏–ø–æ—Ç–µ–∫–∏ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º –∏–∑–Ω–∞—á–∞–ª—å–Ω—É—é —Å—É–º–º—É)
        if (homeValue > 0) {
          const mortgageProgress =
            ((homeValue - mortgageDebt) / homeValue) * 100;
          document.getElementById("mortgageProgress").textContent =
            mortgageProgress.toFixed(1) + "%";
          document.getElementById("mortgageBar").style.width =
            mortgageProgress + "%";
        }

        // –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–≥–∞—à–µ–Ω–∏—è –∞–≤—Ç–æ–∫—Ä–µ–¥–∏—Ç–∞ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –º–∞—à–∏–Ω–∞ —Å—Ç–æ–∏–ª–∞ –ø—Ä–∏–º–µ—Ä–Ω–æ —Å—Ç–æ–ª—å–∫–æ –∂–µ)
        const carValue = 35000; // —Ç–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
        const originalCarLoan = 50000; // –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–∞—è –∏–∑–Ω–∞—á–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
        if (autoDebt > 0) {
          const autoProgress =
            ((originalCarLoan - autoDebt) / originalCarLoan) * 100;
          document.getElementById("autoProgress").textContent =
            autoProgress.toFixed(1) + "%";
          document.getElementById("autoBar").style.width = autoProgress + "%";
        }

        // –†–∞—Å—á–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞ –ø–µ—Ä–∏–æ–¥
        if (financialData.snapshots.length > 0) {
          const lastSnapshot =
            financialData.snapshots[financialData.snapshots.length - 1];
          const change = netWorth - lastSnapshot.netWorth;
          document.getElementById("periodChange").textContent =
            (change >= 0 ? "+" : "") + formatCAD(change);
          document.getElementById("periodChange").className =
            change >= 0 ? "amount positive" : "amount negative";
        }
      }

      function saveSnapshot() {
        const date = document.getElementById("recordDate").value;
        if (!date) {
          alert("Please select a date");
          return;
        }

        // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–æ–≤
        const assets = [];
        const assetRows = document.querySelectorAll("#assetsTable tbody tr");
        assetRows.forEach((row) => {
          const category = row.cells[0].querySelector("select").value;
          const name = row.cells[1].querySelector("input").value;
          const amount =
            parseFloat(row.cells[2].querySelector("input").value) || 0;
          const note = row.cells[4].querySelector("input").value;
          if (name && amount > 0) {
            assets.push({ category, name, amount, note });
          }
        });

        // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–æ–ª–≥–æ–≤
        const liabilities = [];
        const liabilityRows = document.querySelectorAll(
          "#liabilitiesTable tbody tr"
        );
        liabilityRows.forEach((row) => {
          const type = row.cells[0].querySelector("select").value;
          const creditor = row.cells[1].querySelector("input").value;
          const amount =
            parseFloat(row.cells[2].querySelector("input").value) || 0;
          const payment =
            parseFloat(row.cells[3].querySelector("input").value) || 0;
          const rate = row.cells[4].querySelector("input").value;
          if (creditor && amount > 0) {
            liabilities.push({ type, creditor, amount, payment, rate });
          }
        });

        // –†–∞—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤
        const totalAssets = assets.reduce((sum, item) => sum + item.amount, 0);
        const totalLiabilities = liabilities.reduce(
          (sum, item) => sum + item.amount,
          0
        );
        const netWorth = totalAssets - totalLiabilities;

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–Ω–∏–º–∫–∞
        const snapshot = {
          date,
          assets,
          liabilities,
          totalAssets,
          totalLiabilities,
          netWorth,
        };

        financialData.snapshots.push(snapshot);
        localStorage.setItem("financialData", JSON.stringify(financialData));

        alert("Data saved successfully!");
        updateChart();
      }

      function updateChart() {
        const canvas = document.getElementById("netWorthChart");
        const ctx = canvas.getContext("2d");

        if (financialData.snapshots.length === 0) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.fillText(
            "No data to display",
            canvas.width / 2 - 70,
            canvas.height / 2
          );
          return;
        }

        // –ü—Ä–æ—Å—Ç–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
        const snapshots = financialData.snapshots.slice(-12); // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 12 –∑–∞–ø–∏—Å–µ–π
        const maxValue = Math.max(...snapshots.map((s) => s.netWorth));
        const minValue = Math.min(...snapshots.map((s) => s.netWorth));
        const range = maxValue - minValue || 1;

        canvas.width = canvas.offsetWidth;
        canvas.height = 300;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = "#667eea";
        ctx.lineWidth = 2;
        ctx.beginPath();

        snapshots.forEach((snapshot, index) => {
          const x = (index / (snapshots.length - 1)) * (canvas.width - 40) + 20;
          const y =
            canvas.height -
            (((snapshot.netWorth - minValue) / range) * (canvas.height - 40) +
              20);

          if (index === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }

          // –¢–æ—á–∫–∞
          ctx.fillStyle = "#667eea";
          ctx.beginPath();
          ctx.arc(x, y, 4, 0, Math.PI * 2);
          ctx.fill();

          // –ü–æ–¥–ø–∏—Å—å –¥–∞—Ç—ã
          ctx.fillStyle = "#666";
          ctx.font = "10px Arial";
          ctx.save();
          ctx.translate(x, canvas.height - 5);
          ctx.rotate(-Math.PI / 4);
          ctx.fillText(snapshot.date, 0, 0);
          ctx.restore();
        });

        ctx.stroke();
      }

      function exportToExcel() {
        // –°–æ–∑–¥–∞–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ CSV –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
        let csv = "Financial Tracker Export\n\n";

        // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        csv += "CURRENT SNAPSHOT\n";
        csv += "Date," + document.getElementById("recordDate").value + "\n\n";

        // –ê–∫—Ç–∏–≤—ã
        csv += "ASSETS\n";
        csv += "Category,Name,Amount (CAD),Notes\n";
        const assetRows = document.querySelectorAll("#assetsTable tbody tr");
        assetRows.forEach((row) => {
          const category = row.cells[0].querySelector("select").value;
          const name = row.cells[1].querySelector("input").value;
          const amount = row.cells[2].querySelector("input").value || 0;
          const note = row.cells[4].querySelector("input").value;
          csv += `${category},${name},${amount},${note}\n`;
        });

        csv += "\nLIABILITIES\n";
        csv += "Type,Creditor,Balance (CAD),Monthly Payment,Interest Rate\n";
        const liabilityRows = document.querySelectorAll(
          "#liabilitiesTable tbody tr"
        );
        liabilityRows.forEach((row) => {
          const type = row.cells[0].querySelector("select").value;
          const creditor = row.cells[1].querySelector("input").value;
          const amount = row.cells[2].querySelector("input").value || 0;
          const payment = row.cells[3].querySelector("input").value || 0;
          const rate = row.cells[4].querySelector("input").value;
          csv += `${type},${creditor},${amount},${payment},${rate}\n`;
        });

        csv += "\nHISTORICAL DATA\n";
        csv += "Date,Total Assets,Total Liabilities,Net Worth\n";
        financialData.snapshots.forEach((snapshot) => {
          csv += `${snapshot.date},${snapshot.totalAssets},${snapshot.totalLiabilities},${snapshot.netWorth}\n`;
        });

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download =
          "financial_tracker_" +
          new Date().toISOString().split("T")[0] +
          ".csv";
        link.click();
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      calculateTotals();
      updateChart();
      initAuth();
    </script>
  </body>
</html>
