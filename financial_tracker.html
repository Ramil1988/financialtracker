<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Financial Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        overflow-x: hidden; /* prevent horizontal bleed */
      }

      .hidden { display: none; }

      .landing {
        max-width: 800px;
        margin: 10vh auto 0;
        background: rgba(255,255,255,0.95);
        border-radius: 16px;
        padding: 40px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      }
      .landing h1 {
        margin-bottom: 10px;
      }
      .landing p { color: #444; margin: 10px 0 20px; }

      .container {
        max-width: 1200px;
        width: 100%;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
        font-size: 2.5em;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .card {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
      }

      .card:hover {
        transform: translateY(-5px);
      }

      .card h3 {
        color: #555;
        font-size: 0.9em;
        text-transform: uppercase;
        margin-bottom: 10px;
      }

      .card .amount {
        font-size: 1.8em;
        font-weight: bold;
        color: #333;
      }

      .positive {
        color: #27ae60;
      }
      .negative {
        color: #e74c3c;
      }

      .section {
        margin-bottom: 30px;
      }

      .section-title {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 15px;
        border-radius: 10px 10px 0 0;
        font-size: 1.3em;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      /* Keep wide tables from overflowing the layout */
      .section {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      table {
        width: 100%;
        table-layout: auto;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
        word-break: normal;
        white-space: nowrap; /* default: keep in one line on wide screens */
        vertical-align: middle;
      }

      /* Ensure tables have a reasonable minimum width so columns stay readable */
      #assetsTable,
      #liabilitiesTable {
        min-width: 900px;
      }

      /* Tighter spacing/typography on small screens */
      @media (max-width: 768px) {
        .container { padding: 16px; }
        /* Card-style rows on mobile */
        .section { overflow-x: visible; }
        table thead { display: none; }
        #assetsTable, #liabilitiesTable { min-width: 0; width: 100%; }
        table, tbody, tr, td { display: block; width: 100%; }
        tbody tr { background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 10px 12px; margin: 12px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        tbody tr td { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; white-space: normal; }
        tbody tr td::before { content: attr(data-label); font-weight: 600; color: #555; margin-right: 12px; }
        tbody tr td input[type="text"],
        tbody tr td input[type="number"],
        tbody tr td select { width: 55%; }
        .btn.btn-delete { align-self: flex-start; }
      }

      th {
        background: #f8f9fa;
        font-weight: 600;
        color: #555;
      }

      tr:hover {
        background: #f8f9fa;
      }

      input[type="text"],
      input[type="number"],
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      /* Make the top date picker compact instead of full width */
      #recordDate, .date-selector .flatpickr-input[type="text"] {
        width: 220px !important;
        display: inline-block;
      }

      input[type="number"] {
        text-align: right;
      }

      .amount-input {
        text-align: right;
        font-variant-numeric: tabular-nums;
        font-feature-settings: "tnum";
      }

      .btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: opacity 0.3s;
      }

      .btn:hover {
        opacity: 0.9;
      }

      .btn[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-delete {
        background: #e74c3c;
        padding: 5px 10px;
      }

      /* Drag & drop handles */
      .drag-handle {
        display: inline-block;
        margin-right: 8px;
        padding: 4px 6px;
        cursor: grab;
        border-radius: 4px;
        background: #eef1ff;
        color: #555;
        user-select: none;
      }
      tr.dragging { opacity: 0.6; }

      .chart-container {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        margin-top: 30px;
      }

      #netWorthChart {
        display: block;
        width: 100% !important;
        max-width: 100%;
        height: 320px !important; /* fixed height to prevent growth on scroll */
      }

      /* Calendar markers for days that have snapshots */
      .flatpickr-day.has-snapshot::after {
        content: '';
        position: absolute;
        width: 6px;
        height: 6px;
        bottom: 4px;
        left: 50%;
        transform: translateX(-50%);
        background: #667eea;
        border-radius: 50%;
      }

      .date-selector {
        margin-bottom: 20px;
        text-align: center;
      }

      .date-selector input {
        margin: 0 10px;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ddd;
      }

      /* Fancy, responsive top toolbar */
      .date-selector {
        margin-bottom: 20px;
        text-align: center;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        gap: 12px;
        background: #ffffff;
        padding: 12px 16px;
        border-radius: 10px;
        box-shadow: 0 4px 14px rgba(0,0,0,0.06);
      }
      .date-selector label { white-space: nowrap; color: #333; }
      .currency-note { color:#666; font-size: 12px; margin-left:8px; }
      .date-selector input {
        margin: 0 10px;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ddd;
      }
      @media (max-width: 768px) {
        .date-selector { flex-direction: column; align-items: stretch; gap: 8px; }
        .date-selector label { align-self: flex-start; }
        .date-selector .flatpickr-input[type="text"],
        #recordDate,
        #compareDate,
        .date-selector .btn { width: 100% !important; }
        .currency-note { align-self:flex-start; margin-left:0; }
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .metric-box {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .metric-box h3 {
        color: #667eea;
        margin-bottom: 15px;
      }

      .metric-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 10px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        transition: width 0.5s ease;
      }
    </style>
  </head>
  <body>
    <div id="auth-landing" class="landing">
      <h1>üí∞ Financial Tracker</h1>
      <p>Sign in to start tracking your assets, debts, and net worth.</p>
      <button id="btn-login" class="btn">üîê Sign in with Auth0</button>
      <div style="margin-top:12px">
        <button id="btn-guest" class="btn" style="background:#27ae60">üß™ Continue without Login</button>
      </div>
    </div>

    <div id="app-container" class="container hidden">
      <h1>üí∞ Financial Tracker</h1>

      <div class="date-selector">
        <label>Record Date:</label>
        <input type="text" id="recordDate" value="" placeholder="YYYY-MM-DD" />
        <label style="margin-left:12px;">Compare From:</label>
        <input type="text" id="compareDate" value="" placeholder="YYYY-MM-DD" />
        <span class="currency-note">All amounts in CAD</span>
        <span style="margin:0 10px; color:#555" id="user-info"></span>
        <button id="btn-logout" class="btn" style="background:#555">üö™ Logout</button>
        <button id="btn-load" class="btn" onclick="loadSnapshot()">üîÑ Load Snapshot</button>
        <button id="btn-delete" class="btn btn-delete" style="background:#c0392b" onclick="deleteSnapshot()">üóëÔ∏è Delete Snapshot</button>
        <button id="btn-save" class="btn" onclick="saveSnapshot()">
          üíæ Save Snapshot
        </button>
        
      </div>

      <div class="summary-cards">
        <div class="card">
          <h3>Total Assets</h3>
          <div class="amount positive" id="totalAssets">$0</div>
        </div>
        <div class="card">
          <h3>Total Liabilities</h3>
          <div class="amount negative" id="totalLiabilities">$0</div>
        </div>
        <div class="card">
          <h3>Equity (Assets - Liabilities)</h3>
          <div class="amount" id="netWorth">$0</div>
        </div>
        <div class="card">
          <h3>Debt-to-Assets Ratio</h3>
          <div class="amount" id="debtRatio">0%</div>
        </div>
        <div class="card">
          <h3>Assets Change <span id="periodChangeLeft">‚Äî</span> vs <span id="periodChangeRight">‚Äî</span></h3>
          <div class="amount" id="periodChange">$0</div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">
          <span>üìà Assets</span>
          <button class="btn" onclick="addAssetRow()">+ Add Asset</button>
        </div>
        <table id="assetsTable">
          <thead>
            <tr>
              <th>Category</th>
              <th>Name</th>
              <th>Amount ($)</th>
              <th>% of Assets</th>
              <th>Note</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <select>
                  <option>Cash</option>
                  <option>Bank Account</option>
                  <option>Investments</option>
                  <option>Real Estate</option>
                  <option>Vehicle</option>
                  <option>RRSP</option>
                  <option>TFSA</option>
                  <option>Other</option>
                </select>
              </td>
              <td><input type="text" value="Working Cash" /></td>
              <td>
                <input
                  type="number"
                  value="4000"
                  onchange="calculateTotals()"
                />
              </td>
              <td class="percentage">0%</td>
              <td><input type="text" value="Do not touch" /></td>
              <td>
                <button class="btn btn-delete" onclick="deleteRow(this)">
                  Delete
                </button>
              </td>
            </tr>
            <tr>
              <td>
                <select>
                  <option>Cash</option>
                  <option>Bank Account</option>
                  <option>Investments</option>
                  <option>Real Estate</option>
                  <option>Vehicle</option>
                  <option>RRSP</option>
                  <option>TFSA</option>
                  <option>Other</option>
                </select>
              </td>
              <td><input type="text" value="Reserve Cash" /></td>
              <td>
                <input
                  type="number"
                  value="10000"
                  onchange="calculateTotals()"
                />
              </td>
              <td class="percentage">0%</td>
              <td><input type="text" value="Emergency Fund" /></td>
              <td>
                <button class="btn btn-delete" onclick="deleteRow(this)">
                  Delete
                </button>
              </td>
            </tr>
            <tr>
              <td>
                <select>
                  <option>Cash</option>
                  <option>Bank Account</option>
                  <option>Investments</option>
                  <option>Real Estate</option>
                  <option>Vehicle</option>
                  <option selected>RRSP</option>
                  <option>TFSA</option>
                  <option>Other</option>
                </select>
              </td>
              <td><input type="text" value="RRSP Accounts" /></td>
              <td>
                <input
                  type="number"
                  value="15000"
                  onchange="calculateTotals()"
                />
              </td>
              <td class="percentage">0%</td>
              <td><input type="text" value="Retirement Savings" /></td>
              <td>
                <button class="btn btn-delete" onclick="deleteRow(this)">
                  Delete
                </button>
              </td>
            </tr>
            <tr>
              <td>
                <select>
                  <option>Cash</option>
                  <option>Bank Account</option>
                  <option>Investments</option>
                  <option selected>Real Estate</option>
                  <option>Vehicle</option>
                  <option>RRSP</option>
                  <option>TFSA</option>
                  <option>Other</option>
                </select>
              </td>
              <td><input type="text" value="House" /></td>
              <td>
                <input
                  type="number"
                  value="320000"
                  onchange="calculateTotals()"
                />
              </td>
              <td class="percentage">0%</td>
              <td><input type="text" value="Primary Residence" /></td>
              <td>
                <button class="btn btn-delete" onclick="deleteRow(this)">
                  Delete
                </button>
              </td>
            </tr>
            <tr>
              <td>
                <select>
                  <option>Cash</option>
                  <option>Bank Account</option>
                  <option>Investments</option>
                  <option>Real Estate</option>
                  <option selected>Vehicle</option>
                  <option>RRSP</option>
                  <option>TFSA</option>
                  <option>Other</option>
                </select>
              </td>
              <td><input type="text" value="Car" /></td>
              <td>
                <input
                  type="number"
                  value="35000"
                  onchange="calculateTotals()"
                />
              </td>
              <td class="percentage">0%</td>
              <td><input type="text" value="" /></td>
              <td>
                <button class="btn btn-delete" onclick="deleteRow(this)">
                  Delete
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="section">
        <div class="section-title">
          <span>üìâ Debts and Liabilities</span>
          <button class="btn" onclick="addLiabilityRow()">
            + Add Debt
          </button>
        </div>
        <table id="liabilitiesTable">
          <thead>
            <tr>
              <th>Debt Type</th>
              <th>Creditor</th>
              <th>Outstanding Balance ($)</th>
              <th>Monthly Payment</th>
              <th>Interest Rate</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <select>
                  <option selected>Mortgage</option>
                  <option>Car Loan</option>
                  <option>Personal Loan</option>
                  <option>Credit Card</option>
                  <option>Private Loan</option>
                  <option>Other</option>
                </select>
              </td>
              <td><input type="text" value="Primary Mortgage" /></td>
              <td>
                <input
                  type="number"
                  value="210000"
                  onchange="calculateTotals()"
                />
              </td>
              <td><input type="number" placeholder="0" /></td>
              <td><input type="text" placeholder="%" /></td>
              <td>
                <button class="btn btn-delete" onclick="deleteRow(this)">
                  Delete
                </button>
              </td>
            </tr>
            <tr>
              <td>
                <select>
                  <option>Mortgage</option>
                  <option selected>Car Loan</option>
                  <option>Personal Loan</option>
                  <option>Credit Card</option>
                  <option>Private Loan</option>
                  <option>Other</option>
                </select>
              </td>
              <td><input type="text" value="Car Loan" /></td>
              <td>
                <input
                  type="number"
                  value="39000"
                  onchange="calculateTotals()"
                />
              </td>
              <td><input type="number" placeholder="0" /></td>
              <td><input type="text" placeholder="%" /></td>
              <td>
                <button class="btn btn-delete" onclick="deleteRow(this)">
                  Delete
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="metrics-grid">
        <div class="metric-box">
          <h3>üìä Key Metrics</h3>
          <div class="metric-item">
            <span>Home Equity:</span>
            <span id="homeEquity">$0</span>
          </div>
          <div class="metric-item">
            <span>Liquid Assets:</span>
            <span id="liquidAssets">$0</span>
          </div>
          <div class="metric-item">
            <span>Investments (RRSP/TFSA):</span>
            <span id="investments">$0</span>
          </div>
          <div class="metric-item">
            <span>Total Debt:</span>
            <span id="totalDebt">$0</span>
          </div>
        </div>

        
      </div>

      <div class="chart-container">
        <h2>üìä Net Worth Trend</h2>
        <canvas id="netWorthChart"></canvas>
      </div>
    </div>

    <script>
      // Lazy-load Auth0 SPA SDK to avoid race conditions
      async function loadAuth0Sdk() {
        if (window.auth0 && window.auth0.createAuth0Client) return;
        await new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = "https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js";
          s.async = true;
          s.onload = () => resolve();
          s.onerror = () => reject(new Error("Auth0 SDK failed to load"));
          document.head.appendChild(s);
        });
      }

      // ==== Auth0 SPA Setup ====
      const authConfig = {
        domain: "dev-1qlaqx8pn3fopdzo.us.auth0.com", // your Auth0 domain
        clientId: "T0jOPj5apIGhd4r6j39a1sPOwcXc360P", // Auth0 SPA Client ID
        audience: "https://financial-tracker.api",
      };

      let auth0Client;
      let GUEST_MODE = false;

      async function updateUI() {
        const isAuth = await auth0Client.isAuthenticated();
        const landing = document.getElementById("auth-landing");
        const app = document.getElementById("app-container");
        const userInfo = document.getElementById("user-info");
        const logoutBtn = document.getElementById("btn-logout");

        if (isAuth) {
          landing.classList.add("hidden");
          app.classList.remove("hidden");
          const user = await auth0Client.getUser();
          userInfo.textContent = user && (user.name || user.email) ? `Hello, ${user.name || user.email}` : "";
          logoutBtn.style.display = "inline-block";
          // If a different user signed in, reset local data to blank
          try {
            const prevSub = localStorage.getItem("lastUserSub") || "";
            const newSub = (user && user.sub) || "";
            if (newSub && newSub !== prevSub) {
              localStorage.setItem("lastUserSub", newSub);
              financialData = { snapshots: [] };
              localStorage.setItem("financialData", JSON.stringify(financialData));
              renderBlankState(true);
              try { if (datePicker) datePicker.redraw(); } catch(_) {}
            }
          } catch(_) {}
          // App became visible; ensure chart sizes and renders correctly
          requestAnimationFrame(() => updateChart());
        } else {
          app.classList.add("hidden");
          landing.classList.remove("hidden");
          userInfo.textContent = "";
          logoutBtn.style.display = "none";
        }
      }

      async function initAuth() {
        await loadAuth0Sdk();
        const createClient = (window.auth0 && window.auth0.createAuth0Client) || window.createAuth0Client;
        auth0Client = await createClient({
          domain: authConfig.domain,
          clientId: authConfig.clientId,
          authorizationParams: {
            audience: authConfig.audience,
            redirect_uri: window.location.origin + "/financial_tracker.html",
          },
          cacheLocation: "localstorage",
        });

        // Handle redirect back from Auth0
        const query = window.location.search;
        if (query.includes("code=") && query.includes("state=")) {
          await auth0Client.handleRedirectCallback();
          window.history.replaceState({}, document.title, window.location.pathname);
        }

        document.getElementById("btn-login").addEventListener("click", () => {
          auth0Client.loginWithRedirect();
        });
        const guestBtn = document.getElementById("btn-guest");
        if (guestBtn) guestBtn.addEventListener("click", enterGuestMode);
        document.getElementById("btn-logout").addEventListener("click", () => {
          try { localStorage.removeItem("financialData"); } catch(_) {}
          auth0Client.logout({ logoutParams: { returnTo: window.location.origin + "/financial_tracker.html" } });
        });

        await updateUI();

        // If authenticated, pull snapshots from cloud and render latest
        try {
          if (await auth0Client.isAuthenticated()) {
            await syncFromCloudAndRender();
          }
        } catch (e) {
          console.warn("Cloud sync on init failed:", e);
        }
      }

      function enterGuestMode() {
        GUEST_MODE = true;
        const landing = document.getElementById("auth-landing");
        const app = document.getElementById("app-container");
        const userInfo = document.getElementById("user-info");
        const logoutBtn = document.getElementById("btn-logout");
        const saveBtn = document.getElementById("btn-save");
        const loadBtn = document.getElementById("btn-load");
        const delBtn = document.getElementById("btn-delete");
        landing.classList.add("hidden");
        app.classList.remove("hidden");
        if (userInfo) userInfo.textContent = "Guest";
        if (logoutBtn) logoutBtn.style.display = "none";
        if (saveBtn) { saveBtn.disabled = true; saveBtn.title = "Saving disabled in guest mode"; }
        if (loadBtn) { loadBtn.disabled = true; loadBtn.title = "Loading disabled in guest mode"; }
        if (delBtn) { delBtn.disabled = true; delBtn.title = "Delete disabled in guest mode"; }
        // Fresh in-memory data only
        financialData = { snapshots: [] };
        renderBlankState(true);
        initDatePicker();
        requestAnimationFrame(() => updateChart());
      }

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
      document.getElementById("recordDate").value = new Date()
        .toISOString()
        .split("T")[0];
      let datePicker = null;
      let comparePicker = null;
      function initDatePicker() {
        if (!window.flatpickr) return;
        if (datePicker) { try { datePicker.destroy(); } catch(_) {} }
        datePicker = flatpickr("#recordDate", {
          dateFormat: "Y-m-d",
          altInput: true,
          altFormat: "d.m.y",
          defaultDate: document.getElementById("recordDate").value,
          disableMobile: true,
          onChange: (selectedDates, dateStr) => {
            const input = document.getElementById("recordDate");
            input.value = dateStr;
            input.dispatchEvent(new Event("change"));
          },
          onDayCreate: function(dObj, dStr, fp, dayElem) {
            const d = dayElem.dateObj;
            const ymd = fp.formatDate(d, "Y-m-d");
            if ((financialData.snapshots || []).some((s) => s.date === ymd)) {
              dayElem.classList.add("has-snapshot");
            }
          },
          onReady: function(selectedDates, dateStr, fp) {
            // Hide the original input to prevent full-width layout from global styles
            const orig = document.getElementById("recordDate");
            if (orig) {
              orig.style.position = "absolute";
              orig.style.left = "-9999px";
              orig.style.width = "0";
              orig.style.opacity = "0";
            }
            // Ensure alt input is compact
            try {
              const alt = fp.altInput;
              if (alt) {
                alt.style.width = "220px";
                alt.style.display = "inline-block";
              }
            } catch(_) {}
          }
        });

        // Initialize compare picker
        if (comparePicker) { try { comparePicker.destroy(); } catch(_) {} }
        comparePicker = flatpickr("#compareDate", {
          dateFormat: "Y-m-d",
          altInput: true,
          altFormat: "d.m.y",
          defaultDate: document.getElementById("compareDate").value || null,
          disableMobile: true,
          onChange: (selectedDates, dateStr) => {
            const input = document.getElementById("compareDate");
            input.value = dateStr;
            calculateTotals();
          },
          onDayCreate: function(dObj, dStr, fp, dayElem) {
            const d = dayElem.dateObj;
            const ymd = fp.formatDate(d, "Y-m-d");
            if ((financialData.snapshots || []).some((s) => s.date === ymd)) {
              dayElem.classList.add("has-snapshot");
            }
          },
          onReady: function(selectedDates, dateStr, fp) {
            const orig = document.getElementById("compareDate");
            if (orig) {
              orig.style.position = "absolute";
              orig.style.left = "-9999px";
              orig.style.width = "0";
              orig.style.opacity = "0";
            }
            try {
              const alt = fp.altInput;
              if (alt) {
                alt.style.width = "220px";
                alt.style.display = "inline-block";
              }
            } catch(_) {}
          }
        });
      }

      // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
  let financialData = JSON.parse(
        localStorage.getItem("financialData") || '{"snapshots": []}'
      );

      // When user changes date, auto-render the nearest snapshot (exact or closest by date)
      (function attachDateChangeHandler() {
        const input = document.getElementById("recordDate");
        if (!input) return;
        input.addEventListener("change", (e) => {
          const d = e.target.value;
          const snap = getNearestSnapshotForDate(d);
          if (snap) {
            renderSnapshotToForm(snap, { keepCurrentDate: true });
            updateChart();
          }
          // If compare date empty, default to previous snapshot before selected date
          const cmpInput = document.getElementById("compareDate");
          if (cmpInput && !cmpInput.value) {
            const prev = getPreviousSnapshotForDate(d);
            if (prev && comparePicker) comparePicker.setDate(prev.date, false);
          }
        });
      })();
      // Initialize date picker after attaching change handler
      initDatePicker();

      let currentRenderedSnapshotDate = null; // actual date of data currently shown

      // Replace table rows with data from a snapshot
      function renderSnapshotToForm(snapshot, opts = {}) {
        if (!snapshot) return;
        const keepCurrentDate = !!opts.keepCurrentDate;
        const assetsTbody = document.querySelector("#assetsTable tbody");
        const liabsTbody = document.querySelector("#liabilitiesTable tbody");

        // Clear existing rows
        assetsTbody.innerHTML = "";
        liabsTbody.innerHTML = "";

        // Populate assets
        (snapshot.assets || []).forEach((a) => {
          const row = assetsTbody.insertRow();
          row.innerHTML = `
            <td>
              <select>
                <option ${a.category === 'Cash' ? 'selected' : ''}>Cash</option>
                <option ${a.category === 'Bank Account' ? 'selected' : ''}>Bank Account</option>
                <option ${a.category === 'Investments' ? 'selected' : ''}>Investments</option>
                <option ${a.category === 'Real Estate' ? 'selected' : ''}>Real Estate</option>
                <option ${a.category === 'Vehicle' ? 'selected' : ''}>Vehicle</option>
                <option ${a.category === 'RRSP' ? 'selected' : ''}>RRSP</option>
                <option ${a.category === 'TFSA' ? 'selected' : ''}>TFSA</option>
                <option ${a.category === 'Other' ? 'selected' : ''}>Other</option>
              </select>
            </td>
            <td><input type="text" value="${(a.name || '').replace(/"/g, '&quot;')}" /></td>
            <td><input class="amount-input" type="text" value="${formatThousands(a.amount || 0)}" onchange="calculateTotals()" /></td>
            <td class="percentage">0%</td>
            <td><input type="text" value="${(a.note || '').replace(/"/g, '&quot;')}" /></td>
            <td><span class="drag-handle" title="Drag to reorder">‚áÖ</span><button class="btn btn-delete" onclick="deleteRow(this)">Delete</button></td>
          `;
        });

        // Populate liabilities
        (snapshot.liabilities || []).forEach((l) => {
          const row = liabsTbody.insertRow();
          row.innerHTML = `
            <td>
              <select>
                <option ${l.type === 'Mortgage' ? 'selected' : ''}>Mortgage</option>
                <option ${l.type === 'Car Loan' ? 'selected' : ''}>Car Loan</option>
                <option ${l.type === 'Personal Loan' ? 'selected' : ''}>Personal Loan</option>
                <option ${l.type === 'Credit Card' ? 'selected' : ''}>Credit Card</option>
                <option ${l.type === 'Private Loan' ? 'selected' : ''}>Private Loan</option>
                <option ${l.type === 'Other' ? 'selected' : ''}>Other</option>
              </select>
            </td>
            <td><input type="text" value="${(l.creditor || '').replace(/"/g, '&quot;')}" /></td>
            <td><input class="amount-input" type="text" value="${formatThousands(l.amount || 0)}" onchange="calculateTotals()" /></td>
            <td><input type="number" value="${l.payment || 0}" /></td>
            <td><input type="text" value="${(l.rate || '').replace(/"/g, '&quot;')}" /></td>
            <td><span class="drag-handle" title="Drag to reorder">‚áÖ</span><button class="btn btn-delete" onclick="deleteRow(this)">Delete</button></td>
          `;
        });

        // Track what date the data is from
        currentRenderedSnapshotDate = snapshot.date || null;

        // Set date and recalc
        if (!keepCurrentDate && snapshot.date) {
          document.getElementById("recordDate").value = snapshot.date;
          try { if (datePicker) datePicker.setDate(snapshot.date, false); } catch(_) {}
        }
        applyResponsiveLabels();
        initDragAndHandles();
        calculateTotals();
      }

      // Clear all rows; optionally add one empty row in each section for convenience
      function renderBlankState(addOneRow = true) {
        const assetsTbody = document.querySelector("#assetsTable tbody");
        const liabsTbody = document.querySelector("#liabilitiesTable tbody");
        if (assetsTbody) assetsTbody.innerHTML = "";
        if (liabsTbody) liabsTbody.innerHTML = "";
        currentRenderedSnapshotDate = null;
        if (addOneRow) {
          try { addAssetRow(); } catch(_) {}
          try { addLiabilityRow(); } catch(_) {}
        }
        applyResponsiveLabels();
        initDragAndHandles();
        calculateTotals();
      }

      // Apply data-label attributes for responsive card view on mobile
      function applyResponsiveLabels() {
        const setLabels = (selector, labels) => {
          const tbody = document.querySelector(selector + " tbody");
          if (!tbody) return;
          tbody.querySelectorAll("tr").forEach((tr) => {
            const tds = tr.querySelectorAll("td");
            labels.forEach((label, idx) => {
              if (tds[idx]) tds[idx].setAttribute("data-label", label);
            });
          });
        };
        setLabels("#assetsTable", [
          "Category",
          "Name",
          "Amount ($)",
          "% of Assets",
          "Note",
          "Action",
        ]);
        setLabels("#liabilitiesTable", [
          "Debt Type",
          "Creditor",
          "Outstanding Balance ($)",
          "Monthly Payment",
          "Interest Rate",
          "Action",
        ]);
      }

      // Pull snapshots from API, persist locally, and render last
      async function syncFromCloudAndRender() {
        const remote = await syncFromCloud();
        if (remote.length > 0) {
          const latest = [...remote].sort((a, b) => (a.date > b.date ? 1 : a.date < b.date ? -1 : 0)).slice(-1)[0];
          renderSnapshotToForm(latest);
          updateChart();
        } else {
          // No server data for this user ‚Äî start with a blank sheet
          renderBlankState(true);
          updateChart();
        }
      }

      // Pull snapshots from API and store locally; return array
      async function syncFromCloud() {
        const result = await apiFetch("/snapshots", { method: "GET" });
        const remote = Array.isArray(result.snapshots) ? result.snapshots : [];
        financialData.snapshots = remote;
        localStorage.setItem("financialData", JSON.stringify(financialData));
        // Refresh date picker markers
        try { if (datePicker) datePicker.redraw(); } catch(_) {}
        try { if (comparePicker) comparePicker.redraw(); } catch(_) {}
        return remote;
      }

      function formatDateDMY(iso) {
        if (!iso || typeof iso !== "string" || !iso.includes("-")) return "‚Äî";
        const [y, m, d] = iso.split("-");
        const dd = (d || "").padStart(2, "0");
        const mm = (m || "").padStart(2, "0");
        const yy = (y || "").slice(-2).padStart(2, "0");
        return `${dd}.${mm}.${yy}`;
      }

      function getNearestSnapshotForDate(date) {
        const snaps = Array.isArray(financialData.snapshots) ? financialData.snapshots : [];
        if (snaps.length === 0) return null;
        // Exact match
        const exact = snaps.find((s) => s.date === date);
        if (exact) return exact;
        const target = Date.parse(date);
        let best = null;
        let bestDiff = Infinity;
        for (const s of snaps) {
          if (!s.date) continue;
          const t = Date.parse(s.date);
          if (isNaN(t) || isNaN(target)) continue;
          const diff = Math.abs(t - target);
          if (diff < bestDiff) {
            bestDiff = diff;
            best = s;
          } else if (diff === bestDiff) {
            // Tie-breaker: prefer earlier date
            if (best && s.date < best.date) best = s;
          }
        }
        return best;
      }

      function getPreviousSnapshotForDate(date) {
        const snaps = Array.isArray(financialData.snapshots) ? financialData.snapshots : [];
        const prior = snaps
          .filter((s) => s.date && s.date < date)
          .sort((a, b) => (a.date > b.date ? 1 : a.date < b.date ? -1 : 0))
          .slice(-1)[0];
        return prior || null;
      }

      function getExactOrPriorSnapshotForDate(date) {
        if (!date) return null;
        const snaps = Array.isArray(financialData.snapshots) ? financialData.snapshots : [];
        const exact = snaps.find((s) => s.date === date);
        if (exact) return exact;
        return getPreviousSnapshotForDate(date);
      }

      // Find and load snapshot by selected date
      async function loadSnapshotByDate(date) {
        if (!date) return;
        // Refresh from cloud if logged in, so we have latest
        try {
          if (auth0Client && (await auth0Client.isAuthenticated())) {
            await syncFromCloud();
          }
        } catch (_) {}

        const snap = getNearestSnapshotForDate(date);
        if (snap) {
          renderSnapshotToForm(snap, { keepCurrentDate: true });
          updateChart();
        }
      }

      // Convenience for button onclick
      function loadSnapshot() {
        const date = document.getElementById("recordDate").value;
        loadSnapshotByDate(date);
      }

      async function deleteSnapshot() {
        if (GUEST_MODE) {
          alert("Guest mode: delete is disabled. Sign in to manage snapshots.");
          return;
        }
        const selectedDate = document.getElementById("recordDate").value;
        const displayed = currentRenderedSnapshotDate || "";
        const hasDisplayed = (financialData.snapshots || []).some((s) => s.date === displayed);
        const hasSelected = (financialData.snapshots || []).some((s) => s.date === selectedDate);
        const target = hasDisplayed ? displayed : (hasSelected ? selectedDate : "");
        if (!target) {
          alert("No snapshot to delete for this date.");
          return;
        }
        if (!confirm(`Delete snapshot for ${target}? This cannot be undone.`)) return;

        // Remove locally
        financialData.snapshots = (financialData.snapshots || []).filter((s) => s.date !== target);
        localStorage.setItem("financialData", JSON.stringify(financialData));

        // Delete from backend if authenticated
        try {
          if (auth0Client && (await auth0Client.isAuthenticated())) {
            await apiFetch(`/snapshots/${encodeURIComponent(target)}`, { method: "DELETE" });
            try { await syncFromCloud(); } catch (_) {}
          }
        } catch (e) {
          console.warn("Cloud delete failed:", e);
        }

        // Re-render: try the nearest snapshot for the currently selected date, or blank
        const nextSnap = getNearestSnapshotForDate(selectedDate);
        if (nextSnap) {
          renderSnapshotToForm(nextSnap, { keepCurrentDate: true });
        } else {
          renderBlankState(true);
        }
        try { if (datePicker) datePicker.redraw(); } catch(_) {}
        try { if (comparePicker) comparePicker.redraw(); } catch(_) {}
        updateChart();
        alert(`Snapshot ${target} deleted.`);
      }

      function formatCAD(amount) {
        return (
          "$" +
          Math.abs(amount).toLocaleString("en-CA", {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          })
        );
      }

      function addAssetRow() {
        const tbody = document.querySelector("#assetsTable tbody");
        const newRow = tbody.insertRow();
        newRow.innerHTML = `
                <td>
                    <select>
                        <option>Cash</option>
                        <option>Bank Account</option>
                        <option>Investments</option>
                        <option>Real Estate</option>
                        <option>Vehicle</option>
                        <option>RRSP</option>
                        <option>TFSA</option>
                        <option>Other</option>
                    </select>
                </td>
                <td><input type="text" placeholder="Name"></td>
                <td><input class="amount-input" type="text" placeholder="0" onchange="calculateTotals()"></td>
                <td class="percentage">0%</td>
                <td><input type="text" placeholder="Note"></td>
                <td><span class="drag-handle" title="Drag to reorder">‚áÖ</span><button class="btn btn-delete" onclick="deleteRow(this)">Delete</button></td>
            `;
        applyResponsiveLabels();
        initDragAndHandles();
      }

      function addLiabilityRow() {
        const tbody = document.querySelector("#liabilitiesTable tbody");
        const newRow = tbody.insertRow();
        newRow.innerHTML = `
                <td>
                    <select>
                        <option>Mortgage</option>
                        <option>Car Loan</option>
                        <option>Personal Loan</option>
                        <option>Credit Card</option>
                        <option>Private Loan</option>
                        <option>Other</option>
                    </select>
                </td>
                <td><input type="text" placeholder="Bank/Creditor Name"></td>
                <td><input class="amount-input" type="text" placeholder="0" onchange="calculateTotals()"></td>
                <td><input type="number" placeholder="0"></td>
                <td><input type="text" placeholder="%"></td>
                <td><span class="drag-handle" title="Drag to reorder">‚áÖ</span><button class="btn btn-delete" onclick="deleteRow(this)">Delete</button></td>
            `;
        applyResponsiveLabels();
        initDragAndHandles();
      }

      function deleteRow(btn) {
        btn.closest("tr").remove();
        calculateTotals();
        applyResponsiveLabels();
        initDragAndHandles();
      }

      // Insert drag handles and enable drag-n-drop reordering for rows
      function initDragAndHandles() {
        ["#assetsTable", "#liabilitiesTable"].forEach((sel) => {
          const tbody = document.querySelector(`${sel} tbody`);
          if (!tbody) return;
          // Add handles if missing
          tbody.querySelectorAll("tr").forEach((tr) => {
            tr.setAttribute("draggable", "true");
            const lastTd = tr.querySelector("td:last-child");
            if (lastTd && !lastTd.querySelector(".drag-handle")) {
              const span = document.createElement("span");
              span.className = "drag-handle";
              span.title = "Drag to reorder";
              span.textContent = "‚áÖ";
              lastTd.insertBefore(span, lastTd.firstChild);
            }
          });
          setupRowDrag(tbody);
        });
      }

      let dragAllowed = false;
      function setupRowDrag(tbody) {
        if (!tbody || tbody._dragSetup) return;
        tbody._dragSetup = true;

        tbody.addEventListener("mousedown", (e) => {
          dragAllowed = !!(e.target && (e.target.classList.contains("drag-handle") || e.target.closest(".drag-handle")));
        });

        let draggingRow = null;

        tbody.addEventListener("dragstart", (e) => {
          const tr = e.target.closest("tr");
          if (!tr || !dragAllowed) {
            e.preventDefault();
            return;
          }
          draggingRow = tr;
          tr.classList.add("dragging");
          e.dataTransfer.effectAllowed = "move";
          try { e.dataTransfer.setData("text/plain", ""); } catch(_) {}
        });

        tbody.addEventListener("dragover", (e) => {
          if (!draggingRow) return;
          e.preventDefault();
          const afterEl = getDragAfterElement(tbody, e.clientY);
          if (afterEl == null) {
            tbody.appendChild(draggingRow);
          } else {
            tbody.insertBefore(draggingRow, afterEl);
          }
        });

        tbody.addEventListener("dragend", () => {
          if (draggingRow) draggingRow.classList.remove("dragging");
          draggingRow = null;
          dragAllowed = false;
          calculateTotals();
        });
      }

      function getDragAfterElement(container, y) {
        const elements = [...container.querySelectorAll("tr:not(.dragging)")];
        let closest = { offset: Number.NEGATIVE_INFINITY, element: null };
        elements.forEach((el) => {
          const box = el.getBoundingClientRect();
          const offset = y - (box.top + box.height / 2);
          if (offset < 0 && offset > closest.offset) {
            closest = { offset, element: el };
          }
        });
        return closest.element;
      }

      function parseAmount(val) {
        if (typeof val !== "string") val = String(val ?? "");
        const cleaned = val.replace(/[^0-9.,\-\s]/g, "").replace(/[\s,]/g, "");
        const num = parseFloat(cleaned);
        return isFinite(num) ? num : 0;
      }

      function formatThousands(num) {
        try {
          return new Intl.NumberFormat("en-US", { maximumFractionDigits: 0 }).format(Number(num || 0)).replace(/,/g, " ");
        } catch {
          return String(num || 0);
        }
      }

      function wireAmountInput(input) {
        if (!input || input._wired) return;
        input._wired = true;
        // Initialize formatted display
        input.value = formatThousands(parseAmount(input.value));
        input.addEventListener("input", (e) => {
          // Allow digits, space, comma, dot and minus
          const raw = e.target.value || "";
          e.target.value = raw.replace(/[^0-9.,\-\s]/g, "");
        });
        input.addEventListener("blur", (e) => {
          e.target.value = formatThousands(parseAmount(e.target.value));
          calculateTotals();
        });
      }

      function initAmountInputs() {
        document.querySelectorAll('#assetsTable tbody tr td:nth-child(3) input, #liabilitiesTable tbody tr td:nth-child(3) input').forEach(wireAmountInput);
      }

      function calculateTotals() {
        // –ü–æ–¥—Å—á–µ—Ç –∞–∫—Ç–∏–≤–æ–≤
        let totalAssets = 0;
        let liquidAssets = 0;
        let investments = 0;
        let homeValue = 0;
        const assetRows = document.querySelectorAll("#assetsTable tbody tr");
        const rowAmounts = [];
        assetRows.forEach((row) => {
          const category = row.cells[0].querySelector("select").value;
          const amount = parseAmount(row.cells[2].querySelector("input").value);
          rowAmounts.push(amount);
          totalAssets += amount;

          // –ü–æ–¥—Å—á–µ—Ç –ª–∏–∫–≤–∏–¥–Ω—ã—Ö –∞–∫—Ç–∏–≤–æ–≤
          if (category === "Cash" || category === "Bank Account") liquidAssets += amount;

          // –ü–æ–¥—Å—á–µ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π
          if (category === "RRSP" || category === "TFSA" || category === "Investments") investments += amount;

          // –°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ–º–∞
          if (category === "Real Estate") homeValue += amount;
        });

        // Second pass to compute % of Assets using the final total
        assetRows.forEach((row, idx) => {
          const amount = rowAmounts[idx] || 0;
          const pct = totalAssets > 0 ? (amount / totalAssets) * 100 : 0;
          row.cells[3].textContent = pct.toFixed(1) + "%";
        });

        // –ü–æ–¥—Å—á–µ—Ç –¥–æ–ª–≥–æ–≤
        let totalLiabilities = 0;
        let mortgageDebt = 0;
        let autoDebt = 0;

        const liabilityRows = document.querySelectorAll(
          "#liabilitiesTable tbody tr"
        );
        liabilityRows.forEach((row) => {
          const type = row.cells[0].querySelector("select").value;
          const amount = parseAmount(row.cells[2].querySelector("input").value);
          totalLiabilities += amount;

          if (type === "Mortgage") {
            mortgageDebt += amount;
          }
          if (type === "Car Loan") {
            autoDebt += amount;
          }
        });

        // –†–∞—Å—á–µ—Ç —á–∏—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        const netWorth = totalAssets - totalLiabilities;
        const debtRatio =
          totalAssets > 0 ? (totalLiabilities / totalAssets) * 100 : 0;

        // –†–∞—Å—á–µ—Ç equity –≤ –¥–æ–º–µ
        const homeEquity = homeValue - mortgageDebt;

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
        document.getElementById("totalAssets").textContent =
          formatCAD(totalAssets);
        document.getElementById("totalLiabilities").textContent =
          formatCAD(totalLiabilities);
        document.getElementById("netWorth").textContent = formatCAD(netWorth);
        document.getElementById("netWorth").className =
          netWorth >= 0 ? "amount positive" : "amount negative";
        document.getElementById("debtRatio").textContent =
          debtRatio.toFixed(1) + "%";
        document.getElementById("debtRatio").className =
          debtRatio > 60 ? "amount negative" : "amount positive";

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
        document.getElementById("homeEquity").textContent =
          formatCAD(homeEquity);
        document.getElementById("liquidAssets").textContent =
          formatCAD(liquidAssets);
        document.getElementById("investments").textContent =
          formatCAD(investments);
        document.getElementById("totalDebt").textContent =
          formatCAD(totalLiabilities);

        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–æ–≤ –º–µ–∂–¥—É –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç–æ–π —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∏ —Ç–µ–∫—É—â–µ–π –ø–æ–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∞—Ç–æ–π
        (function updateAssetsChangeVsPrev() {
          const selectedDate = document.getElementById("recordDate").value;
          const basisDate = currentRenderedSnapshotDate || selectedDate;
          const chosenLeft = document.getElementById("compareDate")?.value || "";
          const leftSnap = chosenLeft ? getExactOrPriorSnapshotForDate(chosenLeft) : getPreviousSnapshotForDate(basisDate);
          const change = leftSnap ? totalAssets - (leftSnap.totalAssets || 0) : 0;
          const el = document.getElementById("periodChange");
          el.textContent = (change >= 0 ? "+" : "") + formatCAD(change);
          el.className = change >= 0 ? "amount positive" : "amount negative";
          const leftEl = document.getElementById("periodChangeLeft");
          const rightEl = document.getElementById("periodChangeRight");
          if (leftEl) leftEl.textContent = leftSnap ? formatDateDMY(leftSnap.date) : (chosenLeft ? formatDateDMY(chosenLeft) : "‚Äî");
          if (rightEl) rightEl.textContent = formatDateDMY(basisDate);
        })();
      }

      async function saveSnapshot() {
        if (GUEST_MODE) {
          alert("Guest mode: saving is disabled. Sign in to save data.");
          return;
        }
        const date = document.getElementById("recordDate").value;
        if (!date) {
          alert("Please select a date");
          return;
        }

        // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–æ–≤
        const assets = [];
        const assetRows = document.querySelectorAll("#assetsTable tbody tr");
        assetRows.forEach((row) => {
          const category = row.cells[0].querySelector("select").value;
          const name = row.cells[1].querySelector("input").value;
          const amount =
            parseFloat(row.cells[2].querySelector("input").value) || 0;
          const note = row.cells[4].querySelector("input").value;
          if (name && amount > 0) {
            assets.push({ category, name, amount, note });
          }
        });

        // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–æ–ª–≥–æ–≤
        const liabilities = [];
        const liabilityRows = document.querySelectorAll(
          "#liabilitiesTable tbody tr"
        );
        liabilityRows.forEach((row) => {
          const type = row.cells[0].querySelector("select").value;
          const creditor = row.cells[1].querySelector("input").value;
          const amount =
            parseFloat(row.cells[2].querySelector("input").value) || 0;
          const payment =
            parseFloat(row.cells[3].querySelector("input").value) || 0;
          const rate = row.cells[4].querySelector("input").value;
          if (creditor && amount > 0) {
            liabilities.push({ type, creditor, amount, payment, rate });
          }
        });

        // –†–∞—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤
        const totalAssets = assets.reduce((sum, item) => sum + item.amount, 0);
        const totalLiabilities = liabilities.reduce(
          (sum, item) => sum + item.amount,
          0
        );
        const netWorth = totalAssets - totalLiabilities;

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–Ω–∏–º–∫–∞
        const snapshot = {
          date,
          assets,
          liabilities,
          totalAssets,
          totalLiabilities,
          netWorth,
        };

        // Upsert into local list by date
        const existingIdx = (financialData.snapshots || []).findIndex((s) => s.date === date);
        if (existingIdx >= 0) {
          financialData.snapshots[existingIdx] = snapshot;
        } else {
          financialData.snapshots.push(snapshot);
        }
        localStorage.setItem("financialData", JSON.stringify(financialData));

        // Try to sync to backend (ignore if not logged in)
        let cloudMsg = "";
        try {
          if (auth0Client && (await auth0Client.isAuthenticated())) {
            await apiFetch("/snapshots", {
              method: "POST",
              body: JSON.stringify({ snapshot }),
            });
            // Refresh local cache from cloud to ensure consistency
            try { await syncFromCloud(); } catch (_) {}
            cloudMsg = " Synced to cloud.";
          }
        } catch (e) {
          console.warn("Cloud sync failed:", e);
          cloudMsg = " (Cloud sync failed)";
        }

        alert("Data saved successfully!" + cloudMsg);
        try { if (datePicker) datePicker.redraw(); } catch(_) {}
        updateChart();
      }

      let nwChart;

      function updateChart() {
        const canvas = document.getElementById("netWorthChart");
        if (!canvas) return;

        const snapshots = (financialData.snapshots || []).slice(-24); // show up to last 24
        const labels = snapshots.map((s) => s.date);
        const data = snapshots.map((s) => s.netWorth);

        if (!window.Chart) return; // Chart.js not loaded yet

        const cfg = {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Equity",
                data,
                borderColor: "#667eea",
                backgroundColor: "rgba(102,126,234,0.2)",
                tension: 0.25,
                pointRadius: 3,
                pointBackgroundColor: "#667eea",
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            devicePixelRatio: 1,
            interaction: { mode: "index", intersect: false },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) => `Equity: ${formatCAD(ctx.parsed.y)}`,
                },
              },
            },
            scales: {
              x: {
                title: { display: true, text: "Date" },
                ticks: { maxRotation: 0, autoSkip: true },
                grid: { display: false },
              },
              y: {
                title: { display: true, text: "$" },
                ticks: {
                  callback: (v) => {
                    try { return formatCAD(v); } catch { return v; }
                  },
                },
              },
            },
          },
        };

        if (nwChart) {
          // Update existing chart
          nwChart.data.labels = labels;
          nwChart.data.datasets[0].data = data;
          nwChart.update();
        } else {
          nwChart = new Chart(canvas.getContext("2d"), cfg);
        }
      }

      // Chart.js handles responsiveness internally; no custom resize handler needed

      // Export removed per request

      // Call backend API with Auth0 token (global)
      async function apiFetch(path, options = {}) {
        if (!auth0Client) throw new Error("Auth not initialized");
        const isAuth = await auth0Client.isAuthenticated();
        if (!isAuth) throw new Error("Not authenticated");
        const token = await auth0Client.getTokenSilently({
          authorizationParams: { audience: authConfig.audience },
        });
        const res = await fetch(`/api${path}`, {
          ...options,
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
            ...(options.headers || {}),
          },
        });
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`API ${res.status}: ${text}`);
        }
        const ct = res.headers.get("content-type") || "";
        return ct.includes("application/json") ? res.json() : res.text();
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (after DOM is ready and SDK loaded)
      window.addEventListener("DOMContentLoaded", async () => {
        applyResponsiveLabels();
        initAmountInputs();
        initDragAndHandles();
        calculateTotals();
        updateChart();
        try { await initAuth(); } catch (e) { console.error(e); }
      });
    </script>
  </body>
</html>
